Option Explicit

' Define required objects
Dim objExcel, objWorkbook, objSheet, objFSO, objFile
Dim row, tableName, avroPath, avroSchema
Dim column, firstColumn, outputFolder
Dim objModel, table, tableFound

' Get active model in PowerDesigner
Set objModel = ActiveModel
If objModel Is Nothing Then
    MsgBox "Error: No active model found in PowerDesigner. Please open a PDM first.", vbCritical
    Exit Sub
End If

' Excel file path (Change if needed)
Dim excelFile
excelFile = "C:\tables.xlsx"

' Avro schema output folder (Change if needed)
outputFolder = "C:\AvroSchemas\"

' Create File System Object for writing files
Set objFSO = CreateObject("Scripting.FileSystemObject")

' Create output folder if it doesn't exist
If Not objFSO.FolderExists(outputFolder) Then
    objFSO.CreateFolder(outputFolder)
End If

' Open Excel
On Error Resume Next
Set objExcel = CreateObject("Excel.Application")
If Err.Number <> 0 Then
    MsgBox "Error: Unable to open Excel. Ensure Excel is installed.", vbCritical
    Exit Sub
End If
On Error GoTo 0

objExcel.Visible = False ' Set to True for debugging
Set objWorkbook = objExcel.Workbooks.Open(excelFile)
Set objSheet = objWorkbook.Sheets(1)

' Read table names from Excel and generate Avro schema
row = 2 ' Assuming row 1 is headers

Do While Trim(objSheet.Cells(row, 1).Value) <> ""
    tableName = Trim(objSheet.Cells(row, 1).Value)
    avroPath = outputFolder & tableName & ".avsc"

    ' Check if table exists in PowerDesigner
    tableFound = False
    For Each table In objModel.Tables
        If UCase(table.Name) = UCase(tableName) Then
            tableFound = True
            Exit For
        End If
    Next

    If tableFound Then
        ' Generate Avro schema
        Set objFile = objFSO.CreateTextFile(avroPath, True)
        objFile.WriteLine "{"
        objFile.WriteLine """type"": ""record"","
        objFile.WriteLine """name"": """ & tableName & ""","
        objFile.WriteLine """fields"": ["

        firstColumn = True

        ' Extract columns for the given table
        For Each column In table.Columns
            If Not firstColumn Then objFile.WriteLine ","
            firstColumn = False
            
            objFile.WriteLine "  {"
            objFile.WriteLine "    ""name"": """ & column.Name & ""","
            objFile.WriteLine "    ""type"": """ & MapDataType(column.DataType) & """"
            objFile.WriteLine "  }"
        Next

        objFile.WriteLine "]"
        objFile.WriteLine "}"
        objFile.Close

        MsgBox "Avro schema generated: " & avroPath, vbInformation
    Else
        MsgBox "Table not found in PowerDesigner: " & tableName, vbExclamation
    End If

    row = row + 1
Loop

' Clean up
objWorkbook.Close False
objExcel.Quit
Set objExcel = Nothing
Set objWorkbook = Nothing
Set objSheet = Nothing
Set objFSO = Nothing

MsgBox "Process completed successfully.", vbInformation

' Function to map Oracle data types to Avro types
Function MapDataType(oracleType)
    Select Case UCase(oracleType)
        Case "VARCHAR2", "CHAR", "NVARCHAR2", "CLOB"
            MapDataType = "string"
        Case "NUMBER", "FLOAT", "BINARY_FLOAT", "BINARY_DOUBLE"
            MapDataType = "double"
        Case "DATE", "TIMESTAMP"
            MapDataType = "string" ' Handle as ISO date-time strings
        Case Else
            MapDataType = "string"
    End Select
End Function