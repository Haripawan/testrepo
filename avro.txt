Option Explicit

Dim objPowerDesigner, objModel, objExcel, objWorkbook, objSheet, objFSO, objFile
Dim row, tableName, avroPath, column, firstColumn
Dim table, tableFound, modelPath, outputFolder
Dim physDataModel, targetPDM

' Hardcoded PDM file location
modelPath = "C:\models\database.pdm"

' Name of the specific Physical Data Model to filter tables from
targetPDM = "My_Physical_Model"  ' Change this to your actual PDM name

' Start PowerDesigner
Set objPowerDesigner = CreateObject("PowerDesigner.Application")
If objPowerDesigner Is Nothing Then
    MsgBox "Error: PowerDesigner is not running.", vbCritical
    WScript.Quit
End If

' Open the PDM model
Set objModel = objPowerDesigner.OpenModel(modelPath)
If objModel Is Nothing Then
    MsgBox "Error: Unable to open the PDM file. Please check the path.", vbCritical
    WScript.Quit
End If

' Find the Physical Data Model inside the PDM
Set physDataModel = Nothing
Dim subModel
For Each subModel In objModel.Models
    If UCase(subModel.Name) = UCase(targetPDM) Then
        Set physDataModel = subModel
        Exit For
    End If
Next

If physDataModel Is Nothing Then
    MsgBox "Error: Physical Data Model '" & targetPDM & "' not found.", vbCritical
    WScript.Quit
End If

' Excel file containing table names
Dim excelFile
excelFile = "C:\tables.xlsx"

' Output folder for Avro schema files
outputFolder = "C:\AvroSchemas\"

' Create File System Object
Set objFSO = CreateObject("Scripting.FileSystemObject")

' Create output folder if it doesn't exist
If Not objFSO.FolderExists(outputFolder) Then
    objFSO.CreateFolder(outputFolder)
End If

' Open Excel
On Error Resume Next
Set objExcel = CreateObject("Excel.Application")
If Err.Number <> 0 Then
    MsgBox "Error: Unable to open Excel. Ensure Excel is installed.", vbCritical
    WScript.Quit
End If
On Error GoTo 0

objExcel.Visible = False ' Hide Excel
Set objWorkbook = objExcel.Workbooks.Open(excelFile)
Set objSheet = objWorkbook.Sheets(1)

' Read table names from Excel and generate Avro schema
row = 2 ' Assuming row 1 contains headers

Do While Trim(objSheet.Cells(row, 1).Value) <> ""
    tableName = Trim(objSheet.Cells(row, 1).Value)
    avroPath = outputFolder & "\" & tableName & ".avsc"

    ' Check if table exists in the specific Physical Data Model
    tableFound = False
    For Each table In physDataModel.Tables
        If UCase(table.Name) = UCase(tableName) Then
            tableFound = True
            Exit For
        End If
    Next

    If tableFound Then
        ' Generate Avro schema
        Set objFile = objFSO.CreateTextFile(avroPath, True)
        objFile.WriteLine "{"
        objFile.WriteLine """type"": ""record"","
        objFile.WriteLine """name"": """ & tableName & ""","
        objFile.WriteLine """fields"": ["

        firstColumn = True

        ' Extract columns for the given table
        For Each column In table.Columns
            If Not firstColumn Then objFile.WriteLine ","
            firstColumn = False
            
            objFile.WriteLine "  {"
            objFile.WriteLine "    ""name"": """ & column.Name & ""","
            objFile.WriteLine "    ""type"": """ & MapDataType(column.DataType) & """"
            objFile.WriteLine "  }"
        Next

        objFile.WriteLine "]"
        objFile.WriteLine "}"
        objFile.Close

        MsgBox "Avro schema generated: " & avroPath, vbInformation
    Else
        MsgBox "Table not found in Physical Data Model: " & tableName, vbExclamation
    End If

    row = row + 1
Loop

' Clean up Excel
objWorkbook.Close False
objExcel.Quit
Set objExcel = Nothing
Set objWorkbook = Nothing
Set objSheet = Nothing
Set objFSO = Nothing

MsgBox "Process completed successfully.", vbInformation

' Function to map Oracle data types to Avro types
Function MapDataType(oracleType)
    Select Case UCase(oracleType)
        Case "VARCHAR2", "CHAR", "NVARCHAR2", "CLOB"
            MapDataType = "string"
        Case "NUMBER", "FLOAT", "BINARY_FLOAT", "BINARY_DOUBLE"
            MapDataType = "double"
        Case "DATE", "TIMESTAMP"
            MapDataType = "string" ' Handle as ISO date-time strings
        Case Else
            MapDataType = "string"
    End Select
End Function