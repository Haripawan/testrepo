<!-- Load Select2 for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  .filter-config, .filter-controls {
    margin: 10px 0;
    padding: 10px;
    border: 1px solid #ddd;
    background: #f9f9f9;
  }
  .filter-controls select, .filter-controls input[type="date"] {
    width: 180px;
    margin: 5px;
  }
</style>

<div class="filter-config">
  <strong>📌 Select columns to filter:</strong><br/>
  <div id="filter-column-list"></div>
  <button onclick="generateFiltersFromSelection()">Generate Filters</button>
</div>

<div class="filter-controls" id="filter-controls" style="display:none;">
  <strong>🔍 Apply Filters:</strong><br/>
  <div id="filter-fields"></div>
  <button onclick="applyTableFilters()">Apply</button>
  <button onclick="resetTableFilters()" style="margin-left: 10px;">Reset</button>
</div>

<script>
let selectedColumns = [];

document.addEventListener('DOMContentLoaded', () => {
  const table = document.querySelector('.confluenceTable');
  if (!table) return;

  const headerCells = table.querySelectorAll('thead th');
  const columnListDiv = document.getElementById('filter-column-list');
  columnListDiv.innerHTML = '';

  headerCells.forEach((th, index) => {
    const label = document.createElement('label');
    label.innerHTML = `
      <input type="checkbox" value="${index}" />
      ${th.textContent.trim()}
    `;
    columnListDiv.appendChild(label);
    columnListDiv.appendChild(document.createElement('br'));
  });
});

function generateFiltersFromSelection() {
  const table = document.querySelector('.confluenceTable');
  const rows = table.querySelectorAll('tbody tr');
  const headers = table.querySelectorAll('thead th');
  const selected = document.querySelectorAll('#filter-column-list input:checked');
  const filterFields = document.getElementById('filter-fields');

  if (selected.length === 0) {
    alert("Please select at least one column.");
    return;
  }

  filterFields.innerHTML = '';
  selectedColumns = [];

  selected.forEach(cb => {
    const colIndex = parseInt(cb.value);
    const headerText = headers[colIndex].textContent.trim();
    selectedColumns.push(colIndex);

    // Check for date column
    const isDate = headerText.toLowerCase().includes('date');
    if (isDate) {
      const input = document.createElement('input');
      input.type = 'date';
      input.setAttribute('data-col', colIndex);
      filterFields.appendChild(document.createTextNode(headerText + ": "));
      filterFields.appendChild(input);
    } else {
      // Collect unique values
      const uniqueVals = new Set();
      rows.forEach(r => {
        const val = r.cells[colIndex]?.textContent.trim();
        if (val) uniqueVals.add(val);
      });

      const select = document.createElement('select');
      select.setAttribute('multiple', 'multiple');
      select.setAttribute('data-col', colIndex);

      Array.from(uniqueVals).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });

      filterFields.appendChild(document.createTextNode(headerText + ": "));
      filterFields.appendChild(select);
      $(select).select2({ width: '180px', placeholder: headerText });
    }
  });

  document.getElementById('filter-controls').style.display = 'block';
}

function applyTableFilters() {
  const table = document.querySelector('.confluenceTable');
  const rows = table.querySelectorAll('tbody tr');
  const filters = document.querySelectorAll('#filter-fields [data-col]');

  rows.forEach(row => {
    let show = true;
    filters.forEach(f => {
      const col = parseInt(f.getAttribute('data-col'));
      const cellVal = row.cells[col]?.textContent.trim().toLowerCase() || "";

      if (f.type === 'date') {
        const filterVal = f.value;
        if (filterVal && cellVal !== filterVal) show = false;
      } else {
        const selected = $(f).val() || [];
        if (selected.length > 0 && !selected.includes(cellVal)) show = false;
      }
    });
    row.style.display = show ? "" : "none";
  });
}

function resetTableFilters() {
  const filters = document.querySelectorAll('#filter-fields [data-col]');
  filters.forEach(f => {
    if (f.type === 'date') f.value = '';
    else $(f).val(null).trigger('change');
  });

  const table = document.querySelector('.confluenceTable');
  table.querySelectorAll('tbody tr').forEach(r => r.style.display = '');
}
</script>

{html:script=true|style=true|iframe=false}
<!-- Paste the full code here (as provided in previous message) -->
{/html}