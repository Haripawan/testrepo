<!-- Load Select2 for dropdown filters -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
  .filter-controls select, .filter-controls input[type="date"] {
    margin: 6px;
    width: 200px;
  }
  .modal {
    display: none;
    position: fixed;
    z-index: 99;
    background: white;
    border: 1px solid #aaa;
    padding: 15px;
    width: 300px;
    top: 20%;
    left: 40%;
    box-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  .modal-header { font-weight: bold; margin-bottom: 10px; }
  .modal-footer { margin-top: 10px; text-align: right; }
  .modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 98;
    display: none;
  }
</style>

<button onclick="showFilterConfig()">⚙️ Configure Filter Columns</button>
<div class="filter-controls" id="filter-controls" style="display:none;">
  <strong>Filters:</strong>
  <div id="filter-fields"></div>
  <button onclick="applyTableFilters()">Apply</button>
  <button onclick="resetTableFilters()" style="margin-left:10px;">Reset</button>
</div>

<!-- Modal for header selection -->
<div class="modal-overlay" id="modal-overlay"></div>
<div class="modal" id="headerModal">
  <div class="modal-header">Select Columns to Filter</div>
  <div id="modal-body"></div>
  <div class="modal-footer">
    <button onclick="applyHeaderSelection()">Apply</button>
    <button onclick="closeModal()" style="margin-left: 10px;">Cancel</button>
  </div>
</div>

<script>
let selectedCols = [];

function showFilterConfig() {
  const table = document.querySelector('.confluenceTable');
  if (!table) {
    alert("⚠️ No table found on this page.");
    return;
  }

  const headers = table.querySelectorAll('thead th');
  const modalBody = document.getElementById('modal-body');
  modalBody.innerHTML = '';

  headers.forEach((th, index) => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" value="${index}"> ${th.textContent.trim()}`;
    modalBody.appendChild(label);
    modalBody.appendChild(document.createElement('br'));
  });

  document.getElementById('modal-overlay').style.display = 'block';
  document.getElementById('headerModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('modal-overlay').style.display = 'none';
  document.getElementById('headerModal').style.display = 'none';
}

function applyHeaderSelection() {
  const selected = document.querySelectorAll('#modal-body input:checked');
  selectedCols = Array.from(selected).map(cb => parseInt(cb.value));
  closeModal();
  generateFilterFields();
}

function generateFilterFields() {
  const table = document.querySelector('.confluenceTable');
  const headers = table.querySelectorAll('thead th');
  const rows = table.querySelectorAll('tbody tr');
  const filterFields = document.getElementById('filter-fields');

  if (selectedCols.length === 0) return;

  filterFields.innerHTML = '';
  document.getElementById('filter-controls').style.display = 'block';

  selectedCols.forEach(colIndex => {
    const header = headers[colIndex].textContent.trim();
    const isDate = header.toLowerCase().includes('date');

    if (isDate) {
      const input = document.createElement('input');
      input.type = 'date';
      input.setAttribute('data-col', colIndex);
      filterFields.appendChild(document.createTextNode(header + ": "));
      filterFields.appendChild(input);
    } else {
      const select = document.createElement('select');
      select.setAttribute('multiple', 'multiple');
      select.setAttribute('data-col', colIndex);

      const unique = new Set();
      rows.forEach(row => {
        const val = row.cells[colIndex]?.textContent.trim();
        if (val) unique.add(val);
      });

      Array.from(unique).sort().forEach(v => {
        const option = document.createElement('option');
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
      });

      filterFields.appendChild(document.createTextNode(header + ": "));
      filterFields.appendChild(select);
      $(select).select2({ width: '200px', placeholder: header });
    }
  });
}

function applyTableFilters() {
  const table = document.querySelector('.confluenceTable');
  const rows = table.querySelectorAll('tbody tr');
  const filters = document.querySelectorAll('#filter-fields [data-col]');

  rows.forEach(row => {
    let show = true;
    filters.forEach(f => {
      const col = parseInt(f.getAttribute('data-col'));
      const cell = row.cells[col];
      const val = cell ? cell.textContent.trim().toLowerCase() : '';

      if (f.type === 'date') {
        const filterVal = f.value;
        if (filterVal && val !== filterVal) show = false;
      } else {
        const selectedVals = $(f).val() || [];
        if (selectedVals.length > 0 && !selectedVals.includes(val)) show = false;
      }
    });
    row.style.display = show ? '' : 'none';
  });
}

function resetTableFilters() {
  const filters = document.querySelectorAll('#filter-fields [data-col]');
  filters.forEach(f => {
    if (f.type === 'date') f.value = '';
    else $(f).val(null).trigger('change');
  });

  const table = document.querySelector('.confluenceTable');
  table.querySelectorAll('tbody tr').forEach(r => r.style.display = '');
}
</script>